<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Notes</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div style="background: #ffeeba; color: #856404; padding: 10px; margin-bottom: 20px; border-radius: 5px; border: 1px solid #ffeeba; text-align: center;">
            <strong>DEBUG:</strong> Template rendered successfully. If you see this, Flask and Jinja are working.
        </div>
        {% if view == "login" %}
        <!-- Login View -->
        <h2>Secret Notes</h2>
        {% if error %}
        <div class="error">
            {{ error }}
        </div>
        {% endif %}
        <form method="POST" action="{{ url_for('login') }}">
            <div class="form-group">
                <input type="text" name="username" placeholder="Username" required>
            </div>
            <div class="form-group">
                <input type="password" name="password" placeholder="Password" required>
            </div>
            <button type="submit">Login</button>
        </form>
        <p class="support-text">
            Need help? <a href="mailto:support@secretnotes.com">Contact support</a>
        </p>
        {% endif %}

        {% if view == "notes" %}
        <!-- Notes Dashboard View -->
        <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
        <h2>My Secret Notes</h2>
        
        <div class="form-group">
            <input type="text" id="searchInput" placeholder="Search notes..." onkeyup="filterNotes()" class="search-input">
        </div>

        <form id="new-note-form">
            <div class="form-group">
                <input type="text" id="note-title" placeholder="Note Title" required>
            </div>
            <div class="form-group">
                <textarea id="note-body" placeholder="Write your note here..." required></textarea>
            </div>
            <button type="submit">Add Note</button>
        </form>

        <div id="notes-container">
            <!-- Notes will be dynamically inserted here -->
        </div>

        <!-- Share Modal -->
        <div id="share-modal" class="share-modal" style="display: none;">
            <h3>Share Note</h3>
            <div class="form-group">
                <input type="password" id="share-password" placeholder="Set password for sharing">
            </div>
            <div id="share-url" style="display: none;">
                <p>Share this URL:</p>
                <input type="text" id="share-link" readonly>
            </div>
            <button id="generate-share-link">Generate Share Link</button>
            <button onclick="closeShareModal()">Close</button>
        </div>
        <div id="modal-backdrop" class="modal-backdrop" style="display: none;"></div>

        <script>
            // Load notes when page loads
            document.addEventListener('DOMContentLoaded', loadNotes);

            // Handle new note submission
            document.getElementById('new-note-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                try {
                    const title = document.getElementById('note-title').value;
                    const body = document.getElementById('note-body').value;

                    const response = await fetch('/api/notes', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ title, body })
                    });

                    if (response.ok) {
                        document.getElementById('note-title').value = '';
                        document.getElementById('note-body').value = '';
                        loadNotes();
                    } else {
                        const data = await response.json();
                        throw new Error(data.error || 'Failed to create note');
                    }
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            });

            // Load all notes
            async function loadNotes() {
                try {
                    const response = await fetch('/api/notes');
                    if (!response.ok) {
                        throw new Error('Failed to load notes');
                    }
                    const notes = await response.json();
                    const container = document.getElementById('notes-container');
                    container.innerHTML = '';

                    notes.forEach(note => {
                        container.insertAdjacentHTML('beforeend', `
                        <div class="note-card" data-content="${note.title.toLowerCase()} ${note.body.toLowerCase()}">
                            <div class="note-actions">
                                <button onclick="shareNote(${note.id})" class="share-btn">Share</button>
                                <button onclick="deleteNote(${note.id})" class="delete-btn">Delete</button>
                            </div>
                            <h3 class="note-title">${note.title}</h3>
                            <p class="note-body">${note.body}</p>
                            <div class="note-meta">
                                <small>Created: ${new Date(note.created_at).toLocaleString()}</small>
                                <br>
                                <small>Updated: ${new Date(note.updated_at).toLocaleString()}</small>
                            </div>
                        </div>
                    `);
                    });
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            }

            // Filter notes
            function filterNotes() {
                const query = document.getElementById('searchInput').value.toLowerCase();
                const notes = document.querySelectorAll('.note-card');
                notes.forEach(note => {
                    const content = note.getAttribute('data-content');
                    note.style.display = content.includes(query) ? '' : 'none';
                });
            }

            // Delete a note
            async function deleteNote(id) {
                if (!confirm('Are you sure you want to delete this note?')) return;
                
                try {
                    const response = await fetch(`/api/notes/${id}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        loadNotes();
                    } else {
                        const data = await response.json();
                        throw new Error(data.error || 'Failed to delete note');
                    }
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            }

            // Share modal functionality
            let currentNoteId = null;

            function showShareModal(noteId) {
                currentNoteId = noteId;
                document.getElementById('share-modal').style.display = 'block';
                document.getElementById('modal-backdrop').style.display = 'block';
                document.getElementById('share-url').style.display = 'none';
                document.getElementById('share-password').value = '';
            }

            function closeShareModal() {
                document.getElementById('share-modal').style.display = 'none';
                document.getElementById('modal-backdrop').style.display = 'none';
            }

            async function shareNote(id) {
                showShareModal(id);
            }

            document.getElementById('generate-share-link').addEventListener('click', async () => {
                const password = document.getElementById('share-password').value;
                if (!password) {
                    alert('Please enter a password');
                    return;
                }

                try {
                    const response = await fetch(`/api/notes/${currentNoteId}/share`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ password })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const shareUrl = window.location.origin + data.url;
                        document.getElementById('share-url').style.display = 'block';
                        document.getElementById('share-link').value = shareUrl;
                    } else {
                        const data = await response.json();
                        throw new Error(data.error || 'Failed to generate share link');
                    }
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            });
        </script>
        {% endif %}

        {% if view == "shared" %}
        <!-- Shared Note View -->
        <h2>Access Protected Note üîê</h2>
        {% if error %}
        <div class="error">
            {{ error }}
        </div>
        {% endif %}
        <form method="POST">
            <div class="form-group">
                <p>This note is password protected. Please enter the password to view it.</p>
                <input type="password" name="password" placeholder="Enter password" required>
            </div>
            <button type="submit">View Note</button>
        </form>
        {% endif %}
    </div>
</body>
</html>
